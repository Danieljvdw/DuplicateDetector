<Window x:Class="DuplicateDetector.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:vm="clr-namespace:DuplicateDetector.ViewModels"
        xmlns:conv="clr-namespace:DuplicateDetector.Converters"
        mc:Ignorable="d"
        Title="Duplicate Detector" Height="800" Width="1600"
        FontFamily="Segoe UI">

    <Window.DataContext>
        <vm:MainViewModel/>
    </Window.DataContext>

    <Window.Resources>
        <conv:ByteSizeConverter x:Key="ByteSizeConverter"/>
        <conv:EnumDescriptionConverter x:Key="EnumDescriptionConverter"/>
        <conv:PercentToStarConverter x:Key="PercentToStarConverter"/>
        
        <!-- Override DataGrid font to Roboto -->
        <Style TargetType="DataGrid">
            <Setter Property="FontFamily" Value="Consolas"/>
        </Style>
    </Window.Resources>

    <Grid Margin="10">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="Auto"/>
            <ColumnDefinition Width="Auto"/>
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>

        <!-- Toolbar -->
        <Menu Grid.ColumnSpan="3">
            <MenuItem Header="Help"/>
        </Menu>
        
        <!-- control -->
        <GroupBox Header="Control" Grid.Row="1">
            <StackPanel>
                <Button Content="Pause" Command="{Binding PauseCommand}"/>
                <Button Content="Resume" Command="{Binding ResumeCommand}"/>
                <Button Content="Cancel" Command="{Binding CancelCommand}"/>
                <Button Content="Scan" Command="{Binding ScanCommand}"/>
                <Button Content="Delete Selected" Command="{Binding DeleteSelectedCommand}"/>
                <Button Content="Copy Visible Files" Command="{Binding CopyFilesCommand}"/>
                <TextBlock Text="Selected Algorithm:"/>
                <ComboBox ItemsSource="{Binding CompareAlgorithms}" SelectedItem="{Binding SelectedAlgorithm, Mode=TwoWay}">
                    <ComboBox.ItemTemplate>
                        <DataTemplate>
                            <!-- Binding here is each enum value, not the ViewModel -->
                            <TextBlock Text="{Binding Converter={StaticResource EnumDescriptionConverter}}"/>
                        </DataTemplate>
                    </ComboBox.ItemTemplate>
                </ComboBox>
            </StackPanel>
        </GroupBox>

        <!-- stats -->
        <StackPanel Grid.Row="2">
            <GroupBox Header="Progress">
                <!-- Progress and Stats -->
                <StackPanel>
                    <!-- Percentage text -->
                    <TextBlock Text="{Binding ProgressValue, StringFormat={}{0:0.00}%}"/>

                    <!-- Progress bar -->
                    <ProgressBar Value="{Binding ProgressValue}" Maximum="100"/>

                    <!-- State -->
                    <TextBlock Text="{Binding CurrentState}"/>

                    <!-- ETA -->
                    <TextBlock Text="{Binding EtaText}"/>

                    <!-- Runtime -->
                    <TextBlock Text="{Binding RuntimeText}"/>
                </StackPanel>
            </GroupBox>

            <!-- Stats -->
            <GroupBox Header="Stats">
                <StackPanel>
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <Label Grid.Row="0" Grid.Column="1" Content="Size"/>
                        <Label Grid.Row="0" Grid.Column="2" Content="Files"/>
                        
                        <Label Grid.Row="1" Grid.Column="0" Content="Total: "/>
                        <Label Grid.Row="1" Grid.Column="1" Content="{Binding TotalData, Converter={StaticResource ByteSizeConverter}}"/>
                        <Label Grid.Row="1" Grid.Column="2" Content="{Binding TotalFiles}"/>

                        <Label Grid.Row="2" Grid.Column="0" Content="Unique: " Background="LightBlue"/>
                        <Label Grid.Row="2" Grid.Column="1" Content="{Binding UniqueData, Converter={StaticResource ByteSizeConverter}}" Background="LightBlue"/>
                        <Label Grid.Row="2" Grid.Column="2" Content="{Binding UniqueFiles}" Background="LightBlue"/>

                        <Label Grid.Row="3" Grid.Column="0" Content="Delete: " Background="#FFFFC0C0"/>
                        <Label Grid.Row="3" Grid.Column="1" Content="{Binding DeleteData, Converter={StaticResource ByteSizeConverter}}" Background="#FFFFC0C0"/>
                        <Label Grid.Row="3" Grid.Column="2" Content="{Binding DeleteFiles}" Background="#FFFFC0C0"/>

                        <Label Grid.Row="4" Grid.Column="0" Content="Keep: " Background="#FFC0FFC0"/>
                        <Label Grid.Row="4" Grid.Column="1" Content="{Binding KeepData, Converter={StaticResource ByteSizeConverter}}" Background="#FFC0FFC0"/>
                        <Label Grid.Row="4" Grid.Column="2" Content="{Binding KeepFiles}" Background="#FFC0FFC0"/>

                        <Label Grid.Row="5" Grid.Column="0" Content="Total After Delete: "/>
                        <Label Grid.Row="5" Grid.Column="1" Content="{Binding TotalAfterDeleteData, Converter={StaticResource ByteSizeConverter}}"/>
                        <Label Grid.Row="5" Grid.Column="2" Content="{Binding TotalAfterDeleteFiles}"/>

                    </Grid>
                    
                    <!-- Visual stat representation -->
                    <TextBlock Text="File Breakdown:"/>
                    <DockPanel>
                        <Label Content="Size" DockPanel.Dock="Left"/>
                        <Grid Height="25" HorizontalAlignment="Stretch">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="{Binding KeepPercentageData, Converter={StaticResource PercentToStarConverter}}"/>
                                <ColumnDefinition Width="{Binding DeletePercentageData, Converter={StaticResource PercentToStarConverter}}"/>
                                <ColumnDefinition Width="{Binding UniquePercentageData, Converter={StaticResource PercentToStarConverter}}"/>
                            </Grid.ColumnDefinitions>

                            <Border Grid.Column="0" Background="#FFC0FFC0"/>
                            <Border Grid.Column="1" Background="#FFFFC0C0"/>
                            <Border Grid.Column="2" Background="LightBlue"/>
                        </Grid>
                    </DockPanel>

                    <DockPanel>
                        <Label Content="Files" DockPanel.Dock="Left"/>
                        <Grid Height="25" HorizontalAlignment="Stretch">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="{Binding KeepPercentageFiles, Converter={StaticResource PercentToStarConverter}}"/>
                                <ColumnDefinition Width="{Binding DeletePercentageFiles, Converter={StaticResource PercentToStarConverter}}"/>
                                <ColumnDefinition Width="{Binding UniquePercentageFiles, Converter={StaticResource PercentToStarConverter}}"/>
                            </Grid.ColumnDefinitions>

                            <Border Grid.Column="0" Background="#FFC0FFC0"/>
                            <Border Grid.Column="1" Background="#FFFFC0C0"/>
                            <Border Grid.Column="2" Background="LightBlue"/>
                        </Grid>
                    </DockPanel>
                </StackPanel>
            </GroupBox>

            <!-- Disk view -->
            <GroupBox Header="Disks">
                <ListView ItemsSource="{Binding DiskViewModel.Disks}">
                    <ListView.View>
                        <GridView>
                            <GridViewColumn Header="Drive" DisplayMemberBinding="{Binding DriveLetter}" Width="40"/>
                            <GridViewColumn Header="Total" DisplayMemberBinding="{Binding TotalSpace, Converter={StaticResource ByteSizeConverter}}" Width="70"/>
                            <GridViewColumn Header="Used" DisplayMemberBinding="{Binding UsedSpace, Converter={StaticResource ByteSizeConverter}}" Width="70"/>
                            <GridViewColumn Header="Free" DisplayMemberBinding="{Binding FreeSpace, Converter={StaticResource ByteSizeConverter}}" Width="70"/>
                            <GridViewColumn Header="Utilization" DisplayMemberBinding="{Binding Utilization, StringFormat={}{0:F1}%}" Width="60"/>
                            <GridViewColumn Header="Active Time (%)" DisplayMemberBinding="{Binding ActiveTime, StringFormat={}{0:F1}%}" Width="90"/>
                            <GridViewColumn Header="Read" DisplayMemberBinding="{Binding ReadSpeed, Converter={StaticResource ByteSizeConverter}, ConverterParameter=speed}" Width="85"/>
                            <GridViewColumn Header="Write" DisplayMemberBinding="{Binding WriteSpeed, Converter={StaticResource ByteSizeConverter}, ConverterParameter=speed}" Width="85"/>
                        </GridView>
                    </ListView.View>
                </ListView>
            </GroupBox>
        </StackPanel>

        <!-- Folder List -->
        <GroupBox Header="Folders to Scan" Grid.Row="1" Grid.Column="1" Grid.RowSpan="2">
            <DockPanel LastChildFill="True">
                <!-- Add Folder Button docked to bottom -->
                <Button DockPanel.Dock="Top"
                        Content="Add Folder"
                        Command="{Binding AddFolderCommand}"/>

                <!-- Scrollable List of folders -->
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <ListView ItemsSource="{Binding Folders}">
                        <ListView.View>
                            <GridView>
                                <!-- Folder Path -->
                                <GridViewColumn Header="Folder Path">
                                    <GridViewColumn.HeaderContainerStyle>
                                        <Style TargetType="GridViewColumnHeader">
                                            <Setter Property="HorizontalContentAlignment" Value="Left"/>
                                        </Style>
                                    </GridViewColumn.HeaderContainerStyle>
                                    <GridViewColumn.CellTemplate>
                                        <DataTemplate>
                                            <TextBlock Text="{Binding Path}"
                                                       TextTrimming="CharacterEllipsis"/>
                                        </DataTemplate>
                                    </GridViewColumn.CellTemplate>
                                </GridViewColumn>

                                <!-- Visible -->
                                <GridViewColumn>
                                    <GridViewColumn.Header>
                                        <CheckBox Content="Visible" IsThreeState="True" IsChecked="{Binding AllVisibleChecked}"/>
                                    </GridViewColumn.Header>
                                    <GridViewColumn.CellTemplate>
                                        <DataTemplate>
                                            <CheckBox IsChecked="{Binding IsVisible, Mode=TwoWay}"/>
                                        </DataTemplate>
                                    </GridViewColumn.CellTemplate>
                                </GridViewColumn>

                                <!-- Keep -->
                                <GridViewColumn>
                                    <GridViewColumn.Header>
                                        <CheckBox Content="Keep" IsThreeState="True" IsChecked="{Binding AllKeepChecked}"/>
                                    </GridViewColumn.Header>
                                    <GridViewColumn.CellTemplate>
                                        <DataTemplate>
                                            <CheckBox IsChecked="{Binding ShowKeep, Mode=TwoWay}"/>
                                        </DataTemplate>
                                    </GridViewColumn.CellTemplate>
                                </GridViewColumn>

                                <!-- Delete -->
                                <GridViewColumn>
                                    <GridViewColumn.Header>
                                        <CheckBox Content="Delete" IsThreeState="True" IsChecked="{Binding AllDeleteChecked}"/>
                                    </GridViewColumn.Header>
                                    <GridViewColumn.CellTemplate>
                                        <DataTemplate>
                                            <CheckBox IsChecked="{Binding ShowDelete, Mode=TwoWay}"/>
                                        </DataTemplate>
                                    </GridViewColumn.CellTemplate>
                                </GridViewColumn>

                                <!-- Unique -->
                                <GridViewColumn>
                                    <GridViewColumn.Header>
                                        <CheckBox Content="Unique" IsThreeState="True" IsChecked="{Binding AllUniqueChecked}"/>
                                    </GridViewColumn.Header>
                                    <GridViewColumn.CellTemplate>
                                        <DataTemplate>
                                            <CheckBox IsChecked="{Binding ShowUnique, Mode=TwoWay}"/>
                                        </DataTemplate>
                                    </GridViewColumn.CellTemplate>
                                </GridViewColumn>
                                
                                <!-- Hashing -->
                                <GridViewColumn>
                                    <GridViewColumn.Header>
                                        <CheckBox Content="Hashing" IsThreeState="True" IsChecked="{Binding AllHashingChecked}"/>
                                    </GridViewColumn.Header>
                                    <GridViewColumn.CellTemplate>
                                        <DataTemplate>
                                            <CheckBox IsChecked="{Binding ShowHashing, Mode=TwoWay}"/>
                                        </DataTemplate>
                                    </GridViewColumn.CellTemplate>
                                </GridViewColumn>
                                    
                                <!-- Error -->
                                <GridViewColumn>
                                    <GridViewColumn.Header>
                                        <CheckBox Content="Error" IsThreeState="True" IsChecked="{Binding AllErrorChecked}"/>
                                    </GridViewColumn.Header>
                                    <GridViewColumn.CellTemplate>
                                        <DataTemplate>
                                            <CheckBox IsChecked="{Binding ShowError, Mode=TwoWay}"/>
                                        </DataTemplate>
                                    </GridViewColumn.CellTemplate>
                                </GridViewColumn>

                                <!-- Actions -->
                                <GridViewColumn Header="Actions">
                                    <GridViewColumn.CellTemplate>
                                        <DataTemplate>
                                            <Button Content="Remove"
                                                    Command="{Binding DataContext.RemoveFolderCommand, RelativeSource={RelativeSource AncestorType=ListView}}"
                                                    CommandParameter="{Binding}"/>
                                        </DataTemplate>
                                    </GridViewColumn.CellTemplate>
                                </GridViewColumn>
                            </GridView>
                        </ListView.View>
                    </ListView>
                </ScrollViewer>
            </DockPanel>
        </GroupBox>


        <!-- Files List -->
        <GroupBox Header="Files" Grid.Row="1" Grid.Column="2" Grid.RowSpan="2">
            <DataGrid ItemsSource="{Binding FilesView}" AutoGenerateColumns="False" CanUserAddRows="False" IsReadOnly="True">
                <!-- Hide selection highlight colors -->
                <DataGrid.Resources>
                    <SolidColorBrush x:Key="{x:Static SystemColors.HighlightBrushKey}" Color="Transparent"/>
                    <SolidColorBrush x:Key="{x:Static SystemColors.HighlightTextBrushKey}" Color="Black"/>
                    <SolidColorBrush x:Key="{x:Static SystemColors.InactiveSelectionHighlightBrushKey}" Color="Transparent"/>
                    <SolidColorBrush x:Key="{x:Static SystemColors.ControlBrushKey}" Color="Transparent"/>
                </DataGrid.Resources>

                <!-- Highlight files marked for deletion in light red and keep in light green-->
                <DataGrid.RowStyle>
                    <Style TargetType="DataGridRow">
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding State}" Value="delete">
                                <Setter Property="Background" Value="#FFFFC0C0"/>
                            </DataTrigger>
                            <DataTrigger Binding="{Binding State}" Value="keep">
                                <Setter Property="Background" Value="#FFC0FFC0"/>
                            </DataTrigger>
                            <DataTrigger Binding="{Binding State}" Value="unique">
                                <Setter Property="Background" Value="LightBlue"/>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </DataGrid.RowStyle>

                <!-- define columns to display -->
                <DataGrid.Columns>
                    <DataGridTemplateColumn Header="State" Width="120" SortMemberPath="State">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <Border Background="Transparent" MouseLeftButtonDown="StateCell_MouseLeftButtonDown" HorizontalAlignment="Stretch" VerticalAlignment="Stretch">
                                    <!-- Only show clickable cursor and hover highlight for keep/delete -->
                                    <Border.Style>
                                        <Style TargetType="Border">
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding State}" Value="keep">
                                                    <Setter Property="Cursor" Value="Hand"/>
                                                </DataTrigger>
                                                <DataTrigger Binding="{Binding State}" Value="delete">
                                                    <Setter Property="Cursor" Value="Hand"/>
                                                </DataTrigger>
                                                <DataTrigger Binding="{Binding State}" Value="hashing">
                                                    <Setter Property="Cursor" Value="Hand"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Border.Style>
                                    <TextBlock Text="{Binding State}" HorizontalAlignment="Center" VerticalAlignment="Center" FontWeight="Bold"/>
                                </Border>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>
                    <DataGridTextColumn Header="Filename" Binding="{Binding Filename}" IsReadOnly="True"/>
                    <DataGridTextColumn Header="Size" Binding="{Binding Size, Converter={StaticResource ByteSizeConverter}}" IsReadOnly="True"/>
                    <DataGridTextColumn Header="Hash" Binding="{Binding HashString}" IsReadOnly="True"/>
                </DataGrid.Columns>
            </DataGrid>
        </GroupBox>

        <!-- Status Bar at the bottom -->
        <StatusBar Grid.Row="3" Grid.ColumnSpan="3">
            <TextBlock Text="{Binding Version}" />
        </StatusBar>
    </Grid>
</Window>
